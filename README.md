# 异常概括自动汇总工具 (Exception Summary Automation)

这个工具用于自动化合并、整理和归档每日的业务异常数据。它读取指定目录下的多个业务Excel报表，将其汇总到一个总表中，并根据修复状态自动进行归档。

## 核心功能

1.  **多源数据读取**:
    -   **自营采购退货**: 读取自营退货订单及逆向销售单。
    -   **备件库退货**: 读取备件库退货订单。
    -   **平台零售订单**: 读取销售订单应收、发货通知、销售出库单等。
2.  **数据清洗与合并**:
    -   自动统一列名。
    -   保留并合并历史数据（`异常概括汇总.xlsx`）。
    -   如果存在历史数据，会将新数据按关键列（环节、异常类型、描述等）进行合并。
3.  **自动归档**:
    -   检测“异常修复”列。如果包含“**已修复**”或“**已定位**”，该行数据会被自动移入“**问题归档**”Sheet，不再显示在当前业务Sheet中。
4.  **智能排序与美化**:
    -   **IT异常**优先置顶。
    -   日期列按**倒序排列**（最新的日期显示在最左侧，紧挨固定信息列）。
    -   自动调整Excel行高和列宽，设置自动换行，方便查看。

## 依赖环境

需要 Python 3.x 及以下第三方库：

```bash
pip install pandas openpyxl
```

## 配置说明

脚本中的文件路径目前是硬编码的，使用前请根据实际情况在 `exception_summary.py` 中修改：

```python
# 基础路径
base_path = r"C:\Users\zhangyaolong\Desktop\异常概括"

# 输入文件列表 (示例)
files_self_run = [
    (r"...\每日\自营退货订单项目维度退货单.xlsx", "自营退货订单-项目维度退货单"),
    ...
]
```

## 使用方法

1.  将每日更新的原始报表放入配置指定的文件夹。
2.  运行脚本：
    ```bash
    python exception_summary.py
    ```
3.  脚本运行完成后，会在 `base_path` 下生成或更新 `异常概括汇总.xlsx`。

## 输出文件结构

生成的 `异常概括汇总.xlsx` 包含以下 Sheet：
-   **自营采购退货**
-   **备件库退货**
-   **平台零售订单**
-   **问题归档**: 存放所有已解决的历史问题。

## 功能备注
   **✅异常汇总程序优化**
-   **✅1.更新环节命名**

自营采购退货模块：

自营退货订单-内部退货订单改为：自营退货订单-项目维度退货单
内部退货订单-退货销售单改为：项目维度退货单-逆向销售单

备件库退货模块

备件库退货订单-内部退货订单改为：备件库退货订单-项目维度退货单
内部退货订单-退货销售单改为：项目维度退货单-逆向销售单

平台零售订单模块不变

销售订单-应收单：不变
发货通知单-销售出库单：不变
销售出库单-应收单：不变
-   **✅2.每个环节对应的报表新增了一个异常备注的列**

需求

需求：现有的程序，假设平台零售订单模块：环节为销售订单-应收单、异常类型为未知异常、异常描述为未知描述、异常信息为未找到单据！，在12月23号识别出来190条，经过查询之后，这190条都为九阳锅具的问题，但是还没有解决；如果第二天12月24号，同一个环节、异常类型、异常描述、异常信息，查出来了247条；但是进过排除昨天的190条九阳的问题还没有解决；那么多出来的247-190=57条数据是什么？怎么更加客观的在汇总的报表中分辨出来？
现有状况，每个环节导出的列表，都新增了“异常备注”这一列，假设12月23号190条异常定位为九阳，会在异常备注中做对应的备注，那么第二天怎么利用这个异常备注来分辨已经定位的190和新增的247-190=57条数据？
注意现有的异常概括汇总的表格中有一列备注是我自己加的，和程序导出的异常备注是两个东西

解决方案

将源表自带的“异常备注”也加入到识别标准中。 现在的“身份证”变成了 5 个字段：【环节 + 类型 + 描述 + 信息 + 源表异常备注】。

场景模拟：

12月23日（昨天）：
源表里有 190 条数据，你（或系统）在源表的“异常备注”列填了“九阳锅具问题”。
程序运行结果：汇总表中生成一行，数量 190，源表备注列显示“九阳锅具问题”。
12月24日（今天）：
源表里有 247 条数据。
其中 190 条是旧问题，源表里依然带着（或被VLOOKUP匹配上）“九阳锅具问题”的备注。
另外 57 条是新问题，源表里的“异常备注”是空的。

程序运行结果：

程序发现那 190 条的身份证（含备注“九阳...”）和昨天的一模一样 -> 合并到第一行。
程序发现那 57 条的身份证（备注为空）和昨天的任何行都对不上 -> 自动新增第二行。
 

-   **✅3.问题打标归档**
如何对于“已修复异常”的归档


解决方案


【自动化-状态驱动归档法】不需要手动剪切移动，我们只需要利用“异常修复”这一列作为开关。


新工作流


日常操作：在 自营采购退货 等表格里，当某一行问题解决时，你在 “异常修复” 列填上 “已修复”（或者 “已完结”，统一一个关键词即可）。
无需移动：你不需要把它移走，就留在那儿。
运行脚本：运行 Python 脚本。
自动归档：脚本会自动检测：
识别：凡是“异常修复”列包含“已修复”字的行。
搬运：自动把它完整复制到 问题归档 Sheet 的末尾。
清理：从当前的 自营采购退货 Sheet 里把它删掉。

使用指南

触发条件：在 异常修复 这一列，只要你填的内容里包含 “已修复” 或者 包含 “已定位” 这三个字（比如 已修复、王杰已修复、23号已定位），程序就会识别。
归档位置：程序会自动新建（或追加）一个叫 问题归档 的 Sheet 页，把这些行放进去。
结果：自营采购退货 页面变干净了，只剩没解决的问题；问题归档 页面里留下了历史记录。

-   **✅4.每日增量更新**
已定位和未定位的异常
初步
先根据周2晚上上线备注功能之后，将已备注（已定位）和未定位的区分开
长期优化方案
类似：九阳锅具已经定位到的异常，系统是可以自动识别出来，不再是原有的异常来等待去排查

-   **✅5.日期列倒序**
在代码生成最终表格前，增加一步“对日期列进行降序排序”的操作
